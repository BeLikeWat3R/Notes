
Windows operates in two main modes: 


**User-Mode:** 

Most applications & user processes happen here, applications ran within user mode have very limited access to hardware & have to interact with the OS via APIs. These processes are isolated and cannot directly access hardware/critical functions.

Malware is still able to manipulate files, registry, network connections, etc. & may escalate its privilege in order to gain more control. 

-------------------------------------------

**Kernel-Mode:** 

A much more privileged environment where the Windows kernel runs. The kernel has unfettered access to hardware, system resources, and critical functions. It provides core OS services, manages resources, and enforces security & stability. Device drivers also run within it. 

If malware runs within kernel mode, it will gain elevated control & can manipulate system behavior, conceal itself, intercept syscalls, and tamper with security.

-------------------------------------------

**User-Mode Components:** 

Parts of the OS that do not have direct access to hardware/kernel. They interact with system resources through API & syscalls

| **Component**                | **Description**                                                                                                                                                    | **Examples**                                          |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------- |
| **System Support Processes** | Essential components providing crucial functionalities and services for system operation. These are not Windows services but are necessary for system functioning. | winlogon.exe, smss.exe, services.exe                  |
| **Service Processes**        | Processes that host Windows services, running in the background and executing tasks according to their configuration.                                              | Windows Update Service, Task Scheduler, Print Spooler |
| **User Applications**        | Processes created by user programs, interacting with the operating system through APIs, causing transitions between user mode and kernel mode.                     | 32-bit and 64-bit applications                        |
| **Environment Subsystems**   | Components providing execution environments for specific types of applications or processes.                                                                       | Win32 Subsystem, POSIX, OS/2                          |
| **Subsystem DLLs**           | Dynamic-link libraries translating documented functions into internal native system calls, implemented in NTDLL.DLL.                                               | kernelbase.dll, user32.dll, wininet.dll, advapi32.dll |

-------------------------------------------

**Kernel-Mode Components:** 

Parts of the OS that have direct access to hardware and kernel data structures

| **Component**              | **Description**                                                                                                                                              | **Functions**                                                                                           |
|----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **Executive**              | The upper layer in kernel mode accessed via functions from NTDLL.DLL. It includes components like I/O Manager, Object Manager, Security Reference Monitor, Process Manager, etc. | Manages I/O operations, object management, security, processes; performs checks and delegates operations. |
| **Kernel**                 | Manages system resources and provides low-level services.                                                                                                     | Handles thread scheduling, interrupt and exception dispatching, multiprocessor synchronization.       |
| **Device Drivers**         | Software components that facilitate interaction between the OS and hardware devices.                                                                         | Acts as intermediaries for managing and controlling hardware and software resources.                  |
| **Hardware Abstraction Layer (HAL)** | Provides an abstraction layer between hardware devices and the OS.                                                                                            | Ensures consistent and platform-independent interaction with hardware for software developers.        |
| **Windowing and Graphics System (Win32k.sys)** | Manages the graphical user interface (GUI) and rendering of visual elements on the screen.                                                                 | Handles GUI operations and visual rendering.                                                           |

-------------------------------------------

Windows API Call Flow: 

For example, assume a user-mode application tries to access privileged operations and system resources using the `ReadProcessMemory` function (allows a process to read the memory of other processes). 



![ReadProcessMemoryCall](Assets/Malware%20Analysis/wininternals_syscall.webp)





